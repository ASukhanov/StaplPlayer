' Stapl file for downloading two SVXs
' The FEM should be properly initialized before, i.e. ./stapl_cmdline.py i10 10000000 00100000 240
' And CARB too: i.e. ./stapl_cmdline.py -g i10 17e
' FYI, the python command to reverse the bit order:
' hex(int('{:0192b}'.format(0x020101010101010101010101010101014614c087c4003007)[::-1], 2))
' $e00c0023e103286280808080808080808080808080808040
' $ 3 2 120 9 8 7 6 5 4 3 2 110 9 8 7 6 5 4 3 2 1 0
' #.9.........8.........7.........6.........5.........4.........3.........2.........1.........0.........9.........8.........7.........6.........5.........4.........3.........2.........1.........;
' #.9.........8.........RRG.......6...__ID___.........4.........3.........2.........1.........0.........9.........8.........7.........6.........5.........4.........3.........2.........1.........;
' #111000000000100000001000001010111110010000000011001011000110001010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000001
ACTION	TRANS = DO_TRANS;
DATA PARAMETERS;
BOOLEAN chip1[192];
BOOLEAN chip2[192];
BOOLEAN irdata[10*32];
ENDDATA;
PROCEDURE DO_TRANS USES PARAMETERS;
' Load sequencer with single command '18'
IRSCAN 8, $16, CAPTURE irdata[7..0];
DRSCAN 32, $1ff00000, CAPTURE irdata[31..0];
DRSCAN 32, $00000018, CAPTURE irdata[31..0];
DRSCAN 32, $00120000, CAPTURE irdata[31..0];
DRSCAN 32, $00200000, CAPTURE irdata[31..0];
' Start downloading
IRSCAN 8, $18, CAPTURE irdata[7..0];
'Last chip flag = 0
'           #111000000000100000001000001010111110010000000011001011000110001010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000001
'           #.9.........8.........RRG.......6...__ID___.........4.........3..
DRSCAN 192, #111000000000100000001000001010111110100100000011001011000110001010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000001, CAPTURE chip1[191..0];
EXPORT "Shifted out chip02:", chip1[191..0];
'First chip flag = 0
'           #.9.........8.........RRG.......6...__ID___.........4.........3..
DRSCAN 192, #111000000000100000001000001010111111000100000011001011000110001010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000001, CAPTURE chip1[191..0];
EXPORT "Shifted out chip01:", chip1[191..0];

' Pulse CalStrobe
' Rewrite the sequencer[0:2]
IRSCAN 8, $16, CAPTURE irdata[7..0];
DRSCAN 32, $1ff00000, CAPTURE irdata[31..0];
DRSCAN 32, $00000040, CAPTURE irdata[31..0];
DRSCAN 32, $00120000, CAPTURE irdata[31..0];
DRSCAN 32, $00200000, CAPTURE irdata[31..0];
DRSCAN 32, $1ff00000, CAPTURE irdata[31..0];
' One shot
DRSCAN 32, $4ff00000, CAPTURE irdata[31..0];
PRINT "CalStrobe fired";
ENDPROC;

